package plusm.vilonix.gapi.exploit;

import org.bukkit.event.Event;
import org.bukkit.event.player.PlayerLoginEvent;
import plusm.vilonix.gapi.exploit.imp.Exploit;
import plusm.vilonix.gapi.utils.bukkit.BukkitUtil;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.util.UUID;

public class UUIDSpoof implements Exploit {

    @Override
    public void check(Event event){

        PlayerLoginEvent playerLoginEvent = (PlayerLoginEvent) event;

        final UUID uuid = playerLoginEvent.getPlayer().getUniqueId();
        final String name = playerLoginEvent.getPlayer().getName();

        BukkitUtil.runTaskAsync(() -> {
            final String originalUUID = uuid.toString().replace("-", "");
            final String offlineUUID = UUID.nameUUIDFromBytes(("OfflinePlayer:" + name).getBytes())
                    .toString().replace("-", "");

            if (!originalUUID.contains(offlineUUID)) {
                final String onlineUUID = getOnlineUUID(name);

                if (onlineUUID == null || !onlineUUID.contains(originalUUID)) {
                    playerLoginEvent.setKickMessage("Вы были кикнуты за подмену UUID");
                    playerLoginEvent.setResult(PlayerLoginEvent.Result.KICK_OTHER);
                }

            }
        });

    }

    private String getOnlineUUID(final String name) {
        try {
            final URLConnection connection = new URL("https://api.mojang.com/users/profiles/minecraft/" + name)
                    .openConnection();

            connection.setDoOutput(true);
            connection.connect();

            final BufferedReader bufferedReader = new BufferedReader(
                    new InputStreamReader(connection.getInputStream()));
            final StringBuilder response = new StringBuilder();

            String inputLine;

            while ((inputLine = bufferedReader.readLine()) != null)
                response.append(inputLine).append("\n");

            bufferedReader.close();
            return response.toString();
        } catch (final Exception ignored) {
        }

        return null;
    }

}
