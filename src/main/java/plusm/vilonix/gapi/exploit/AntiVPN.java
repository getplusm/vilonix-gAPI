package plusm.vilonix.gapi.exploit;

import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.stream.JsonReader;
import org.apache.commons.io.IOUtils;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.AsyncPlayerPreLoginEvent;
import plusm.vilonix.gapi.listeners.DListener;
import plusm.vilonix.gapi.loader.DartaAPI;

import java.io.StringReader;
import java.net.URL;

public class AntiVPN extends DListener<DartaAPI> {

    public AntiVPN(DartaAPI plugin) {
        super(plugin);
    }

    @EventHandler
    public void onLogin(final AsyncPlayerPreLoginEvent e) {
        if (this.isProxy(e.getAddress().getHostAddress())) {
            e.disallow(AsyncPlayerPreLoginEvent.Result.KICK_OTHER, "Пожалуйста отключите VPN");
        }
    }

    private synchronized boolean isProxy(final String address) {

        try {

            final String json = new String(IOUtils.toByteArray(new URL("http://proxycheck.io/v2/" + address).openStream()));
            final JsonReader jsonReader = new JsonReader(new StringReader(json));
            jsonReader.setLenient(true);

            final JsonElement element = new JsonParser().parse(jsonReader);
            final JsonObject obj = element.getAsJsonObject();

            if (obj.getAsJsonObject(address).get("proxy").getAsString().equals("yes")) {
                return true;
            }
        } catch (Exception ignored) {
        }

        return false;
    }

}
